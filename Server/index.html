<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://slaclab.github.io/lume-epics/Server/" rel="canonical"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<title>Server - lume-epics</title>
<link href="../css/bootstrap.min.css" rel="stylesheet"/>
<link href="../css/font-awesome.min.css" rel="stylesheet"/>
<link href="../css/base.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet"/>
<script defer="" src="../js/jquery-1.10.2.min.js"></script>
<script defer="" src="../js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
<div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
<div class="container">
<a class="navbar-brand" href="..">lume-epics</a>
<!-- Expander button -->
<button class="navbar-toggler" data-target="#navbar-collapse" data-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<!-- Expanded navigation -->
<div class="navbar-collapse collapse" id="navbar-collapse">
<!-- Main navigation -->
<ul class="nav navbar-nav">
<li class="navitem">
<a class="nav-link" href="..">Overview</a>
</li>
<li class="navitem">
<a class="nav-link" href="../Install/">Install</a>
</li>
<li class="dropdown">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Tutorial <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../BokehServer/">Bokeh Server</a>
</li>
<li>
<a class="dropdown-item" href="../Jupyter/">Jupyter Notebook Demo</a>
</li>
</ul>
</li>
<li class="navitem">
<a class="nav-link" href="../Widgets_doc/">Widgets</a>
</li>
<li class="dropdown active">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Documentation <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../Layout/">Layout</a>
</li>
<li class="dropdown-submenu">
<a class="dropdown-item" href="#">Client</a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../Controller/">Controller</a>
</li>
<li>
<a class="dropdown-item" href="../Monitors/">Monitors</a>
</li>
<li>
<a class="dropdown-item" href="../Widgets/">Widgets</a>
</li>
</ul>
</li>
<li>
<a class="dropdown-item" href="../Model/">Model</a>
</li>
<li>
<a class="dropdown-item active" href="./">Server</a>
</li>
</ul>
</li>
</ul>
<ul class="nav navbar-nav ml-auto">
<li class="nav-item">
<a class="nav-link" href="../Model/" rel="prev">
<i class="fa fa-arrow-left"></i> Previous
                                </a>
</li>
<li class="nav-item">
<a class="nav-link disabled" rel="next">
                                    Next <i class="fa fa-arrow-right"></i>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="https://github.com/slaclab/lume-epics/edit/master/docs/Server.md"><i class="fa fa-github"></i> Edit on GitHub</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container">
<div class="row">
<div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
<div class="navbar-header">
<button class="navbar-toggler collapsed" data-target="#toc-collapse" data-toggle="collapse" title="Table of Contents" type="button">
<span class="fa fa-angle-down"></span>
</button>
</div>
<div class="navbar-collapse collapse card bg-secondary" id="toc-collapse">
<ul class="nav flex-column">
<li class="nav-item" data-level="1"><a class="nav-link" href="#epics-server">EPICS Server</a>
<ul class="nav flex-column">
<li class="nav-item" data-level="2"><a class="nav-link" href="#lume_epics.epics_server">lume_epics.epics_server</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#lume_epics.epics_server.Server">Server</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#lume_epics.epics_ca_server">lume_epics.epics_ca_server</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#lume_epics.epics_ca_server.CADriver">CADriver</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#lume_epics.epics_ca_server.CAServer">CAServer</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#lume_epics.epics_ca_server.build_pvdb">build_pvdb()</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#lume_epics.epics_pva_server">lume_epics.epics_pva_server</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#lume_epics.epics_pva_server.PVAccessInputHandler">PVAccessInputHandler</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#lume_epics.epics_pva_server.PVAServer">PVAServer</a>
<ul class="nav flex-column">
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div></div>
<div class="col-md-9" role="main">
<h1 id="epics-server">EPICS Server</h1>
<p>The lume-epics server synchronizes process variables over Channel Access and pvAccess servers. Updates to input process variables are queued for model execution and the model output is queued for updates over both protocols. </p>
<p><img alt="Server Structure" src="../img/lume-epics.jpeg"/></p>
<div class="doc doc-object doc-module">
<h2 class="hidden-toc" href="#lume_epics.epics_server" id="lume_epics.epics_server" style="visibility: hidden; position: absolute;">
</h2>
<div class="doc doc-contents first">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="lume_epics.epics_server.Server">
<code>Server</code>
</h2>
<div class="doc doc-contents">
<p>Server for EPICS process variables. Can be optionally initialized with only
pvAccess or Channel Access protocols; but, defaults to serving over both. </p>
<p><strong>Attributes:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>model</code></td>
<td><code>SurrogateModel</code></td>
<td>
<p>SurrogateModel class to be served</p>
</td>
</tr>
<tr>
<td><code>input_variables</code></td>
<td><code>List[Variable]</code></td>
<td>
<p>List of lume-model variables passed to model.</p>
</td>
</tr>
<tr>
<td><code>ouput_variables</code></td>
<td><code>List[Variable]</code></td>
<td>
<p>List of lume-model variables to use as 
outputs.</p>
</td>
</tr>
<tr>
<td><code>ca_server</code></td>
<td><code>SimpleServer</code></td>
<td>
<p>Server class that interfaces between the Channel 
Access client and the driver.</p>
</td>
</tr>
<tr>
<td><code>ca_driver</code></td>
<td><code>CADriver</code></td>
<td>
<p>Class used by server to handle to process variable 
read/write requests.</p>
</td>
</tr>
<tr>
<td><code>pva_server</code></td>
<td><code>P4PServer</code></td>
<td>
<p>Threaded p4p server used for serving pvAccess 
variables.</p>
</td>
</tr>
<tr>
<td><code>exit_event</code></td>
<td><code>Event</code></td>
<td>
<p>Threading exit event marking server shutdown.</p>
</td>
</tr>
</tbody>
</table>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_server.Server.__init__">
<code class="highlight language-python">
__init__
(self, model_class, prefix, protocols=['pva', 'ca'], model_kwargs={})

        </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Create OnlineSurrogateModel instance in the main thread and
initialize output variables by running with the input process variable
state, input/output variable tracking, start the server, create the
process variables, and start the driver.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>model_class</code></td>
<td><code>SurrogateModel</code></td>
<td>
<p>Surrogate model class to be</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>prefix</code></td>
<td><code>str</code></td>
<td>
<p>Prefix used to format process variables.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>protocols</code></td>
<td><code>List[str]</code></td>
<td>
<p>List of protocols used to instantiate server.</p>
</td>
<td><code>['pva', 'ca']</code></td>
</tr>
<tr>
<td><code>model_kwargs</code></td>
<td><code>dict</code></td>
<td>
<p>Kwargs to instantiate model.</p>
</td>
<td><code>{}</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_server.py</code></summary>
<pre class="highlight"><code class="language-python">def __init__(
    self,
    model_class: SurrogateModel,
    prefix: str,
    protocols: List[str] = ["pva", "ca"],
    model_kwargs: dict = {},
) -&gt; None:
    """Create OnlineSurrogateModel instance in the main thread and
    initialize output variables by running with the input process variable
    state, input/output variable tracking, start the server, create the
    process variables, and start the driver.

    Args:
        model_class (SurrogateModel): Surrogate model class to be
        instantiated.

        prefix (str): Prefix used to format process variables.

        protocols (List[str]): List of protocols used to instantiate server.

        model_kwargs (dict): Kwargs to instantiate model.


    """
    # check protocol conditions
    if not protocols:
        raise ValueError("Protocol must be provided to start server.")

    if any([protocol not in ["ca", "pva"] for protocol in protocols]):
        raise ValueError(
            'Invalid protocol provided. Protocol options are "pva" '
            '(pvAccess) and "ca" (Channel Access).'
        )

    # need these to be global to access from threads
    self.prefix = prefix
    self.protocols = protocols

    model = model_class(**model_kwargs)
    self.input_variables = model.input_variables


    # update inputs for starting value to be the default
    for variable in self.input_variables.values():
        if variable.value is None:
            variable.value = variable.default

    model_input = list(self.input_variables.values())

    self.input_variables = model.input_variables
    self.output_variables = model.evaluate(model_input)
    self.output_variables = {
        variable.name: variable for variable in self.output_variables
    }

    self.in_queue = multiprocessing.Queue()
    self.out_queues = dict()
    for protocol in protocols:
        self.out_queues[protocol] = multiprocessing.Queue()

    self.exit_event = Event()

    self.comm_thread = threading.Thread(
        target=self.run_comm_thread,
        args=(model_class,),
        kwargs={
            "model_kwargs": model_kwargs,
            "in_queue": self.in_queue,
            "out_queues": self.out_queues
        }
    )

    # track running servers
    self._ca_running = multiprocessing.Value('b', False)
    self._pva_running = multiprocessing.Value('b', False)

    # initialize channel access server
    if "ca" in protocols:
        self.ca_process = CAServer(
            prefix=self.prefix,
            input_variables=self.input_variables,
            output_variables=self.output_variables,
            in_queue=self.in_queue,
            out_queue=self.out_queues["ca"],
            running_indicator=self._ca_running,
        )

    # initialize pvAccess server
    if "pva" in protocols:

        manager = multiprocessing.Manager()
        self._pva_conf = manager.dict()
        self.pva_process = PVAServer(
            prefix=self.prefix,
            input_variables=self.input_variables,
            output_variables=self.output_variables,
            in_queue=self.in_queue,
            out_queue=self.out_queues["pva"],
            running_indicator = self._pva_running,
            conf_proxy = self._pva_conf,
        )
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_server.Server.run_comm_thread">
<code class="highlight language-python">
run_comm_thread
(self, model_class, model_kwargs={}, in_queue=None, out_queues=None)

        </code>
</h3>
<div class="doc doc-contents">
<p>Handles communications between pvAccess server, Channel Access server, and model.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>model_class</code></td>
<td><code></code></td>
<td>
<p>Model class to be executed.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>model_kwargs</code></td>
<td><code>dict</code></td>
<td>
<p>Dictionary of model keyword arguments.</p>
</td>
<td><code>{}</code></td>
</tr>
<tr>
<td><code>in_queue</code></td>
<td><code>&lt;bound method BaseContext.Queue of &lt;multiprocessing.context.DefaultContext object at 0x7f99c4b11e90&gt;&gt;</code></td>
<td></td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>out_queues</code></td>
<td><code>Dict[str, &lt;bound method BaseContext.Queue of &lt;multiprocessing.context.DefaultContext object at 0x7f99c4b11e90&gt;&gt;]</code></td>
<td>
<p>multiprocessing.Queue]): Maps protocol to output assignment queue.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_server.py</code></summary>
<pre class="highlight"><code class="language-python">def run_comm_thread(self, model_class, model_kwargs={}, in_queue: multiprocessing.Queue=None,
                    out_queues: Dict[str, multiprocessing.Queue]=None):
    """Handles communications between pvAccess server, Channel Access server, and model.

    Arguments:
        model_class: Model class to be executed.

        model_kwargs (dict): Dictionary of model keyword arguments.

        in_queue (multiprocessing.Queue): 

        out_queues (Dict[str: multiprocessing.Queue]): Maps protocol to output assignment queue.


    """
    model = model_class(**model_kwargs)

    while not self.exit_event.is_set():
        try:
            data = in_queue.get(timeout=0.1)
            self.input_variables[data["pvname"]].value = data["value"]
            for protocol, queue in out_queues.items():
                if protocol == data["protocol"]:
                    continue
                queue.put(
                    {"input_variables":
                        [self.input_variables[data["pvname"]]]
                    }
                )

            # update output variable state
            model_input = list(self.input_variables.values())
            predicted_output = model.evaluate(model_input)
            for protocol, queue in out_queues.items():
                queue.put({"output_variables": predicted_output},
                          timeout=0.1)
        except Empty:
            continue
        except Full:
            logger.error(f"{protocol} queue is full.")

    logger.info("Stopping comm thread")
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_server.Server.start">
<code class="highlight language-python">
start
(self, monitor=True)

        </code>
</h3>
<div class="doc doc-contents">
<p>Starts server using set server protocol(s).</p>
<p>Args: 
    monitor (bool): Indicates whether to run the server in the background
        or to continually monitor. If monitor = False, the server must be
        explicitly stopped using server.stop()</p>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_server.py</code></summary>
<pre class="highlight"><code class="language-python">def start(self, monitor: bool = True) -&gt; None:
    """Starts server using set server protocol(s).

    Args: 
        monitor (bool): Indicates whether to run the server in the background
            or to continually monitor. If monitor = False, the server must be
            explicitly stopped using server.stop()

    """
    self.comm_thread.start()

    if "ca" in self.protocols:
        self.ca_process.start()

    if "pva" in self.protocols:
        self.pva_process.start()

    if monitor:
        try:
            while True:
                time.sleep(0.1)

        except KeyboardInterrupt:
            self.stop()
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_server.Server.stop">
<code class="highlight language-python">
stop
(self)

        </code>
</h3>
<div class="doc doc-contents">
<p>Stops the server.</p>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_server.py</code></summary>
<pre class="highlight"><code class="language-python">def stop(self) -&gt; None:
    """Stops the server.

    """
    logger.info("Stopping server.")
    self.exit_event.set()
    self.comm_thread.join()

    if "ca" in self.protocols:
        self.ca_process.shutdown()

    if "pva" in self.protocols:
        self.pva_process.shutdown()

    logger.info("Server is stopped.")
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="hidden-toc" href="#lume_epics.epics_ca_server" id="lume_epics.epics_ca_server" style="visibility: hidden; position: absolute;">
</h2>
<div class="doc doc-contents first">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="lume_epics.epics_ca_server.CADriver">
<code>CADriver</code>
</h2>
<div class="doc doc-contents">
<p>Class for handling read and write requests to Channel Access process variables.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_ca_server.CADriver.read">
<code class="highlight language-python">
read
(self, pvname)

        </code>
</h3>
<div class="doc doc-contents">
<p>Method executed by server when clients read a Channel Access process
variable.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pvname</code></td>
<td><code>str</code></td>
<td>
<p>Process variable name.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
<pre class="highlight"><code class="language-python">def read(self, pvname: str) -&gt; Union[float, np.ndarray]:
    """Method executed by server when clients read a Channel Access process
    variable.

    Args:
        pvname (str): Process variable name.

    """
    return self.getParam(pvname)
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_ca_server.CADriver.update_pvs">
<code class="highlight language-python">
update_pvs
(self, variables)

        </code>
</h3>
<div class="doc doc-contents">
<p>Update output Channel Access process variables after model execution.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>variables</code></td>
<td><code>List[lume_model.variables.Variable]</code></td>
<td>
<p>List of variables.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
<pre class="highlight"><code class="language-python">def update_pvs(self, variables: List[Variable]) -&gt; None:
    """Update output Channel Access process variables after model execution.

    Args:
        variables (List[Variable]): List of variables.
    """
    for variable in variables:
        if variable.name in self.server._input_variables and variable.is_constant:
            logger.debug("Cannot update constant variable %s", variable.name)

        else:
            if variable.variable_type == "image":
                logger.debug(
                    "Channel Access image process variable %s updated.",
                    variable.name)
                self.setParam(
                    variable.name + ":ArrayData_RBV", variable.value.flatten()
                )
                self.setParam(variable.name + ":MinX_RBV", variable.x_min)
                self.setParam(variable.name + ":MinY_RBV", variable.y_min)
                self.setParam(variable.name + ":MaxX_RBV", variable.x_max)
                self.setParam(variable.name + ":MaxY_RBV", variable.y_max)

            else:
                logger.debug(
                    "Channel Access process variable %s updated wth value %s.",
                    variable.name, variable.value)
                self.setParam(variable.name, variable.value)

    self.updatePVs()
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_ca_server.CADriver.write">
<code class="highlight language-python">
write
(self, pvname, value)

        </code>
</h3>
<div class="doc doc-contents">
<p>Method executed by server when clients write to a Channel Access process
variable.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pvname</code></td>
<td><code>str</code></td>
<td>
<p>Process variable name.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>value</code></td>
<td><code>Union[float, numpy.ndarray]</code></td>
<td>
<p>Value to assign to the process variable.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
<pre class="highlight"><code class="language-python">def write(self, pvname: str, value: Union[float, np.ndarray]) -&gt; bool:
    """Method executed by server when clients write to a Channel Access process
    variable.


    Args:
        pvname (str): Process variable name.

        value (Union[float, np.ndarray]): Value to assign to the process variable.

    """

    # handle area detector types
    model_var_name = pvname
    if pvname in self.server._child_to_parent_map:
        model_var_name = self.server._child_to_parent_map[pvname]

    if model_var_name in self.server._output_variables:
        logger.warning(
            "Cannot update variable %s. Output variables can only be updated via surrogate model callback.",
            pvname)
        return False

    if model_var_name in self.server._input_variables:

        # handle image variables
        if self.server._input_variables[model_var_name].is_constant:
            logger.debug("Unable to update constant variable %s", model_var_name)

        else:
            self.setParam(pvname, value)
            self.updatePVs()
            logger.debug(
                "Channel Access process variable %s updated with value %s",
                pvname, value)

            self.server.update_pv(pvname=pvname, value=value)
            return True

    else:
        logger.error("%s not found in server variables.", pvname)
        return False
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="lume_epics.epics_ca_server.CAServer">
<code>CAServer</code>
</h2>
<div class="doc doc-contents">
<p>Process-based implementation of Channel Access server.</p>
<p><strong>Attributes:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ca_server</code></td>
<td><code>SimpleServer</code></td>
<td>
<p>pcaspy SimpleServer instance</p>
</td>
</tr>
<tr>
<td><code>ca_driver</code></td>
<td><code>Driver</code></td>
<td>
<p>pcaspy Driver instance</p>
</td>
</tr>
<tr>
<td><code>server_thread</code></td>
<td><code>ServerThread</code></td>
<td>
<p>Thread for running the server</p>
</td>
</tr>
<tr>
<td><code>exit_event</code></td>
<td><code>multiprocessing.Event</code></td>
<td>
<p>Event indicating shutdown</p>
</td>
</tr>
</tbody>
</table>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_ca_server.CAServer.__init__">
<code class="highlight language-python">
__init__
    (self, prefix, input_variables, output_variables, in_queue, out_queue, running_indicator, *
args, **
kwargs)

        </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Initialize server process.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>prefix</code></td>
<td><code>str</code></td>
<td>
<p>EPICS prefix for serving process variables</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>input_variables</code></td>
<td><code>Dict[str, lume_model.variables.InputVariable]</code></td>
<td>
<p>Dictionary mapping pvname to lume-model input variable.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>output_variables</code></td>
<td><code>Dict[str, lume_model.variables.OutputVariable]</code></td>
<td>
<p>Dictionary mapping pvname to lume-model output variable.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>in_queue</code></td>
<td><code>&lt;bound method BaseContext.Queue of &lt;multiprocessing.context.DefaultContext object at 0x7f99c4b11e90&gt;&gt;</code></td>
<td>
<p>Queue for tracking updates to input variables</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>out_queue</code></td>
<td><code>&lt;bound method BaseContext.Queue of &lt;multiprocessing.context.DefaultContext object at 0x7f99c4b11e90&gt;&gt;</code></td>
<td>
<p>Queue for tracking updates to output variables</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
<pre class="highlight"><code class="language-python">def __init__(self,
             prefix: str,
             input_variables: Dict[str, InputVariable], 
             output_variables: Dict[str, OutputVariable],
             in_queue: multiprocessing.Queue, 
             out_queue: multiprocessing.Queue, 
             running_indicator: multiprocessing.Value,
             *args, **kwargs) -&gt; None:
    """Initialize server process.

    Args:
        prefix (str): EPICS prefix for serving process variables

        input_variables (Dict[str, InputVariable]): Dictionary mapping pvname to lume-model input variable.

        output_variables (Dict[str, OutputVariable]):Dictionary mapping pvname to lume-model output variable.

        in_queue (multiprocessing.Queue): Queue for tracking updates to input variables

        out_queue (multiprocessing.Queue): Queue for tracking updates to output variables

    """
    super().__init__(*args, **kwargs)
    self.ca_server = None
    self.ca_driver = None
    self.server_thread = None
    self.exit_event = multiprocessing.Event()
    self._prefix = prefix
    self._input_variables = input_variables
    self._output_variables = output_variables
    self._in_queue = in_queue
    self._out_queue = out_queue
    self._providers = {}
    self._running = running_indicator
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_ca_server.CAServer.run">
<code class="highlight language-python">
run
(self)

        </code>
</h3>
<div class="doc doc-contents">
<p>Start server process.</p>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
<pre class="highlight"><code class="language-python">def run(self) -&gt; None:
    """Start server process.

    """
    self.setup_server()
    self._running.value = True
    while not self.exit_event.is_set():
        try:
            data = self._out_queue.get_nowait()
            inputs = data.get('input_variables', [])
            outputs = data.get('output_variables', [])
            self.update_pvs(inputs, outputs)
        except Empty:
            time.sleep(0.01)
            logger.debug("out queue empty")

    self.server_thread.stop()
    self._running.value = False
    logger.info("Channel access server stopped.")
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_ca_server.CAServer.setup_server">
<code class="highlight language-python">
setup_server
(self)

        </code>
</h3>
<div class="doc doc-contents">
<p>Configure and start server.</p>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
<pre class="highlight"><code class="language-python">def setup_server(self) -&gt; None:
    """Configure and start server.

    """
    # ignore interrupt in subprocess
    signal.signal(signal.SIGINT, signal.SIG_IGN)

    logger.info("Initializing CA server")

    # initialize channel access server
    self.ca_server = SimpleServer()

    # create all process variables using the process variables stored in
    # pvdb with the given prefix
    pvdb, self._child_to_parent_map = build_pvdb(self._input_variables, self._output_variables)
    self.ca_server.createPV(self._prefix + ":", pvdb)

    # set up driver for handing read and write requests to process variables
    self.ca_driver = CADriver(server=self)

    # start the server thread
    self.server_thread = ServerThread(self.ca_server)
    self.server_thread.start()

    logger.info("CA server started")
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_ca_server.CAServer.shutdown">
<code class="highlight language-python">
shutdown
(self)

        </code>
</h3>
<div class="doc doc-contents">
<p>Safely shutdown the server process. </p>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
<pre class="highlight"><code class="language-python">def shutdown(self):
    """Safely shutdown the server process. 

    """
    self.exit_event.set()
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_ca_server.CAServer.update_pv">
<code class="highlight language-python">
update_pv
(self, pvname, value)

        </code>
</h3>
<div class="doc doc-contents">
<p>Adds update to input process variable to the input queue.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pvname</code></td>
<td><code>str</code></td>
<td>
<p>Name of process variable</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>value</code></td>
<td><code>Union[np.ndarray, float]</code></td>
<td>
<p>Value to set </p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
<pre class="highlight"><code class="language-python">def update_pv(self, pvname, value) -&gt; None:
    """Adds update to input process variable to the input queue.

    Args:
        pvname (str): Name of process variable

        value (Union[np.ndarray, float]): Value to set 

    """
    val = value
    pvname = pvname.replace(f"{self._prefix}:", "")
    self._in_queue.put(
        {"protocol": self.protocol, "pvname": pvname, "value": val}
    )
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_ca_server.CAServer.update_pvs">
<code class="highlight language-python">
update_pvs
(self, input_variables, output_variables)

        </code>
</h3>
<div class="doc doc-contents">
<p>Update process variables over Channel Access.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>input_variables</code></td>
<td><code>List[lume_model.variables.InputVariable]</code></td>
<td>
<p>List of lume-epics output variables.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>output_variables</code></td>
<td><code>List[lume_model.variables.OutputVariable]</code></td>
<td>
<p>List of lume-model output variables.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
<pre class="highlight"><code class="language-python">def update_pvs(self, input_variables: List[InputVariable], output_variables: List[OutputVariable]):
    """Update process variables over Channel Access.

    Args:
        input_variables (List[InputVariable]): List of lume-epics output variables.

        output_variables (List[OutputVariable]): List of lume-model output variables.

    """
    variables = input_variables + output_variables
    self.ca_driver.update_pvs(variables)
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="lume_epics.epics_ca_server.build_pvdb">
<code class="highlight language-python">
build_pvdb
(input_variables, output_variables)

        </code>
</h2>
<div class="doc doc-contents">
<p>Utility function for building dictionary (pvdb) used to initialize the channel
access server.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>input_variables</code></td>
<td><code>List[lume_model.variables.InputVariable]</code></td>
<td>
<p>List of lume_model input variables to be served with
channel access server.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>output_variables</code></td>
<td><code>List[lume_model.variables.OutputVariable]</code></td>
<td>
<p>List of lume_model output variables to be served with
channel access server.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tuple</code></td>
<td>
<p>pvdb (dict)
child_to_parent_map (dict): Mapping of child pvs to parent model variables</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
<pre class="highlight"><code class="language-python">def build_pvdb(input_variables: List[InputVariable],
               output_variables: List[OutputVariable]) -&gt; tuple:
    """Utility function for building dictionary (pvdb) used to initialize the channel
    access server.

    Args:
        input_variables (List[InputVariable]): List of lume_model input variables to be served with
            channel access server.

        output_variables (List[OutputVariable]): List of lume_model output variables to be served with
            channel access server.

    Returns:
        pvdb (dict)
        child_to_parent_map (dict): Mapping of child pvs to parent model variables

    """
    pvdb = {}

    # convert to list
    variables = copy.deepcopy(input_variables)
    variables.update(output_variables)
    variables = list(variables.values())

    child_to_parent_map = {}

    for variable in variables:
        if variable.variable_type == "image":

            # infer color mode
            if variable.value.ndim == 2:
                color_mode = 0

            elif variable.value:
                raise Exception(
                    "Color mode cannot be inferred from image shape.")

            # assign default PVS
            pvdb.update(
                {
                    f"{variable.name}:NDimensions_RBV": {
                        "type": "float",
                        "prec": variable.precision,
                        "value": variable.value.ndim,
                    },
                    f"{variable.name}:Dimensions_RBV": {
                        "type": "int",
                        "prec": variable.precision,
                        "count": variable.value.ndim,
                        "value": variable.value.shape,
                    },
                    f"{variable.name}:ArraySizeX_RBV": {
                        "type": "int",
                        "value": variable.value.shape[0],
                    },
                    f"{variable.name}:ArraySizeY_RBV": {
                        "type": "int",
                        "value": variable.value.shape[1],
                    },
                    f"{variable.name}:ArraySize_RBV": {
                        "type": "int",
                        "value": int(np.prod(variable.value.shape)),
                    },
                    f"{variable.name}:ArrayData_RBV": {
                        "type": "float",
                        "prec": variable.precision,
                        "count": int(np.prod(variable.value.shape)),
                        "value": variable.value.flatten(),
                    },
                    f"{variable.name}:MinX_RBV": {
                        "type": "float",
                        "value": variable.x_min,
                    },
                    f"{variable.name}:MinY_RBV": {
                        "type": "float",
                        "value": variable.y_min,
                    },
                    f"{variable.name}:MaxX_RBV": {
                        "type": "float",
                        "value": variable.x_max,
                    },
                    f"{variable.name}:MaxY_RBV": {
                        "type": "float",
                        "value": variable.y_max,
                    },
                    f"{variable.name}:ColorMode_RBV": {
                        "type": "int",
                        "value": color_mode,
                    },
                }
            )

            child_to_parent_map.update({f"{variable.name}:{child}":variable.name for child in ["NDimensions_RBV","Dimensions_RBV", "ArraySizeX_RBV","ArraySizeY_RBV", "ArraySize_RBV", "ArrayData_RBV", "MinX_RBV","MinY_RBV", "MaxX_RBV", "MaxY_RBV", "ColorMode_RBV"]})

            if "units" in variable.__fields_set__:
                pvdb[f"{variable.name}:ArrayData_RBV"]["unit"] = variable.units

            # placeholder for color images, not yet implemented
            if variable.value.ndim &gt; 2:
                pvdb[f"{variable.name}:ArraySizeZ_RBV"] = {
                    "type": "int",
                    "value": variable.value.shape[2],
                }

        else:
            pvdb[variable.name] = variable.dict(
                exclude_unset=True, by_alias=True
            )
            if variable.value_range is not None:
                pvdb[variable.name]["hilim"] = variable.value_range[1]
                pvdb[variable.name]["lolim"] = variable.value_range[0]

            if variable.units is not None:
                pvdb[variable.name]["unit"] = variable.units

    return pvdb, child_to_parent_map
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="hidden-toc" href="#lume_epics.epics_pva_server" id="lume_epics.epics_pva_server" style="visibility: hidden; position: absolute;">
</h2>
<div class="doc doc-contents first">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="lume_epics.epics_pva_server.PVAccessInputHandler">
<code>PVAccessInputHandler</code>
</h2>
<div class="doc doc-contents">
<p>Handler object that defines the callbacks to execute on put operations to input 
process variables.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_pva_server.PVAccessInputHandler.__init__">
<code class="highlight language-python">
__init__
(self, pvname, is_constant, server)

        </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Initialize the handler with prefix and image pv attributes</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pvname</code></td>
<td><code>str</code></td>
<td>
<p>The PV being handled</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>server</code></td>
<td><code>PVAServer</code></td>
<td>
<p>Reference to the server holding this PV</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
<pre class="highlight"><code class="language-python">def __init__(self, pvname: str, is_constant: bool, server: PVAServer):
    """
    Initialize the handler with prefix and image pv attributes

    Args:
        pvname (str): The PV being handled
        server (PVAServer): Reference to the server holding this PV

    """
    self.is_constant = is_constant
    self.pvname = pvname
    self.server = server
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_pva_server.PVAccessInputHandler.put">
<code class="highlight language-python">
put
(self, pv, op)

        </code>
</h3>
<div class="doc doc-contents">
<p>Updates the global input process variable state, posts the input process
variable value change, runs the thread local OnlineSurrogateModel instance
using the updated global input process variable states, and posts the model
output values to the output process variables.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pv</code></td>
<td><code>SharedPV</code></td>
<td>
<p>Input process variable on which the put operates.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>op</code></td>
<td><code>ServOpWrap</code></td>
<td>
<p>Server operation initiated by the put call.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
<pre class="highlight"><code class="language-python">def put(self, pv: SharedPV, op: ServOpWrap) -&gt; None:
    """Updates the global input process variable state, posts the input process
    variable value change, runs the thread local OnlineSurrogateModel instance
    using the updated global input process variable states, and posts the model
    output values to the output process variables.

    Args:
        pv (SharedPV): Input process variable on which the put operates.

        op (ServOpWrap): Server operation initiated by the put call.

    """
    # update input values and global input process variable state
    if not self.is_constant:
        pv.post(op.value())
        self.server.update_pv(pvname=self.pvname, value=op.value())
    # mark server operation as complete
    op.done()
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="lume_epics.epics_pva_server.PVAServer">
<code>PVAServer</code>
</h2>
<div class="doc doc-contents">
<p>Process-based implementation of Channel Access server.</p>
<p><strong>Attributes:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pva_server</code></td>
<td><code>P4PServer</code></td>
<td>
<p>p4p server instance</p>
</td>
</tr>
<tr>
<td><code>exit_event</code></td>
<td><code>multiprocessing.Event</code></td>
<td>
<p>Event indicating shutdown</p>
</td>
</tr>
</tbody>
</table>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_pva_server.PVAServer.__init__">
<code class="highlight language-python">
__init__
    (self, prefix, input_variables, output_variables, in_queue, out_queue, running_indicator, conf_proxy, *
args, **
kwargs)

        </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Initialize server process.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>prefix</code></td>
<td><code>str</code></td>
<td>
<p>EPICS prefix for serving process variables</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>input_variables</code></td>
<td><code>List[lume_model.variables.InputVariable]</code></td>
<td>
<p>Dictionary mapping pvname to lume-model input variable.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>output_variables</code></td>
<td><code>List[lume_model.variables.OutputVariable]</code></td>
<td>
<p>Dictionary mapping pvname to lume-model output variable.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>in_queue</code></td>
<td><code>&lt;bound method BaseContext.Queue of &lt;multiprocessing.context.DefaultContext object at 0x7f99c4b11e90&gt;&gt;</code></td>
<td>
<p>Queue for tracking updates to input variables</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>out_queue</code></td>
<td><code>&lt;bound method BaseContext.Queue of &lt;multiprocessing.context.DefaultContext object at 0x7f99c4b11e90&gt;&gt;</code></td>
<td>
<p>Queue for tracking updates to output variables</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
<pre class="highlight"><code class="language-python">def __init__(
    self,
    prefix: str,
    input_variables: List[InputVariable],
    output_variables: List[OutputVariable],
    in_queue: multiprocessing.Queue,
    out_queue: multiprocessing.Queue,
    running_indicator: multiprocessing.Value,
    conf_proxy: DictProxy,
    *args,
    **kwargs,
) -&gt; None:
    """Initialize server process.

    Args:
        prefix (str): EPICS prefix for serving process variables

        input_variables (Dict[str, InputVariable]): Dictionary mapping pvname to lume-model input variable.

        output_variables (Dict[str, OutputVariable]):Dictionary mapping pvname to lume-model output variable.

        in_queue (multiprocessing.Queue): Queue for tracking updates to input variables

        out_queue (multiprocessing.Queue): Queue for tracking updates to output variables

    """

    super().__init__(*args, **kwargs)
    self.pva_server = None
    self.exit_event = multiprocessing.Event()
    self._prefix = prefix
    self._input_variables = input_variables
    self._output_variables = output_variables
    self._in_queue = in_queue
    self._out_queue = out_queue
    self._providers = {}
    self._conf = conf_proxy
    self._running = running_indicator
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_pva_server.PVAServer.run">
<code class="highlight language-python">
run
(self)

        </code>
</h3>
<div class="doc doc-contents">
<p>Start server process.</p>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
<pre class="highlight"><code class="language-python">def run(self) -&gt; None:
    """Start server process.

    """
    self.setup_server()
    self._running.value = True

    # mark running
    while not self.exit_event.is_set():
        try:
            data = self._out_queue.get_nowait()
            inputs = data.get("input_variables", [])
            outputs = data.get("output_variables", [])
            self.update_pvs(inputs, outputs)
        except Empty:
            time.sleep(0.01)
            logger.debug("out queue empty")

    self.pva_server.stop()
    self._running.value = False
    logger.info("pvAccess server stopped.")
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_pva_server.PVAServer.setup_server">
<code class="highlight language-python">
setup_server
(self)

        </code>
</h3>
<div class="doc doc-contents">
<p>Configure and start server.</p>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
<pre class="highlight"><code class="language-python">def setup_server(self) -&gt; None:
    """Configure and start server.

    """
    # ignore interrupt in subprocess
    signal.signal(signal.SIGINT, signal.SIG_IGN)

    logger.info("Initializing pvAccess server")
    # initialize global inputs
    for variable in self._input_variables.values():
        pvname = f"{self._prefix}:{variable.name}"

        # prepare scalar variable types
        if variable.variable_type == "scalar":
            nt = NTScalar("d")
            initial = variable.value
        # prepare image variable types
        elif variable.variable_type == "image":
            nd_array = variable.value.view(NTNDArrayData)
            nd_array.attrib = {
                "x_min": variable.x_min,
                "y_min": variable.y_min,
                "x_max": variable.x_max,
                "y_max": variable.y_max,
            }
            nt = NTNDArray()
            initial = nd_array
        else:
            raise ValueError(
                "Unsupported variable type provided: %s", variable.variable_type
            )

        handler = PVAccessInputHandler(
            pvname=pvname, is_constant=variable.is_constant, server=self
        )
        pv = SharedPV(handler=handler, nt=nt, initial=initial)
        self._providers[pvname] = pv

    # use default handler for the output process variables
    # updates to output pvs are handled from post calls within the input
    # update
    for variable in self._output_variables.values():
        pvname = f"{self._prefix}:{variable.name}"
        if variable.variable_type == "scalar":
            nt = NTScalar()
            initial = variable.value

        elif variable.variable_type == "image":
            nd_array = variable.value.view(NTNDArrayData)

            # get image limits from model output
            nd_array.attrib = {
                "x_min": np.float64(variable.x_min),
                "y_min": np.float64(variable.y_min),
                "x_max": np.float64(variable.x_max),
                "y_max": np.float64(variable.y_max),
            }

            nt = NTNDArray()
            initial = nd_array
        else:
            raise ValueError(
                "Unsupported variable type provided: %s", variable.variable_type
            )
        pv = SharedPV(nt=nt, initial=initial)
        self._providers[pvname] = pv

    else:
        pass  # throw exception for incorrect data type

    # initialize pva server
    self.pva_server = P4PServer(providers=[self._providers])

    # update configuration
    for key in self.pva_server.conf():
        self._conf[key]= self.pva_server.conf()[key]

    logger.info("pvAccess server started")
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_pva_server.PVAServer.shutdown">
<code class="highlight language-python">
shutdown
(self)

        </code>
</h3>
<div class="doc doc-contents">
<p>Safely shutdown the server process. </p>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
<pre class="highlight"><code class="language-python">def shutdown(self):
    """Safely shutdown the server process. 

    """
    self.exit_event.set()
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_pva_server.PVAServer.update_pv">
<code class="highlight language-python">
update_pv
(self, pvname, value)

        </code>
</h3>
<div class="doc doc-contents">
<p>Adds update to input process variable to the input queue.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pvname</code></td>
<td><code>str</code></td>
<td>
<p>Name of process variable</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>value</code></td>
<td><code>Union[numpy.ndarray, float]</code></td>
<td>
<p>Value to set </p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
<pre class="highlight"><code class="language-python">def update_pv(self, pvname: str, value: Union[np.ndarray, float]) -&gt; None:
    """Adds update to input process variable to the input queue.

    Args:
        pvname (str): Name of process variable

        value (Union[np.ndarray, float]): Value to set 

    """
    # Hack for now to get the pickable value
    val = value.raw.value
    pvname = pvname.replace(f"{self._prefix}:", "")
    self._in_queue.put({"protocol": self.protocol, "pvname": pvname, "value": val})
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="lume_epics.epics_pva_server.PVAServer.update_pvs">
<code class="highlight language-python">
update_pvs
(self, input_variables, output_variables)

        </code>
</h3>
<div class="doc doc-contents">
<p>Update process variables over pvAccess.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>input_variables</code></td>
<td><code>List[lume_model.variables.InputVariable]</code></td>
<td>
<p>List of lume-epics output variables.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>output_variables</code></td>
<td><code>List[lume_model.variables.OutputVariable]</code></td>
<td>
<p>List of lume-model output variables.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
<pre class="highlight"><code class="language-python">def update_pvs(
    self,
    input_variables: List[InputVariable],
    output_variables: List[OutputVariable],
) -&gt; None:
    """Update process variables over pvAccess.

    Args:
        input_variables (List[InputVariable]): List of lume-epics output variables.

        output_variables (List[OutputVariable]): List of lume-model output variables.

    """
    variables = input_variables + output_variables
    for variable in variables:

        if variable.name in self._input_variables and variable.is_constant:
            logger.debug("Cannot update constant variable.")

        else:
            pvname = f"{self._prefix}:{variable.name}"
            if variable.variable_type == "image":
                logger.debug(
                    "pvAccess image process variable %s updated.", variable.name
                )
                nd_array = variable.value.view(NTNDArrayData)

                # get dw and dh from model output
                nd_array.attrib = {
                    "x_min": variable.x_min,
                    "y_min": variable.y_min,
                    "x_max": variable.x_max,
                    "y_max": variable.y_max,
                }
                value = nd_array
            # do not build attribute pvs
            else:
                logger.debug(
                    "pvAccess process variable %s updated with value %s.",
                    variable.name,
                    variable.value,
                )
                value = variable.value

        output_provider = self._providers[pvname]
        output_provider.post(value)
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div></div>
</div>
</div>
<footer class="col-md-12">
<hr/>
<p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
</footer>
<script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
<script defer="" src="../js/base.js"></script>
<div aria-hidden="true" aria-labelledby="keyboardModalLabel" class="modal" id="mkdocs_keyboard_modal" role="dialog" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
<button class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
</div>
<div class="modal-body">
<table class="table">
<thead>
<tr>
<th style="width: 20%;">Keys</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="help shortcut"><kbd>?</kbd></td>
<td>Open this help</td>
</tr>
<tr>
<td class="next shortcut"><kbd>n</kbd></td>
<td>Next page</td>
</tr>
<tr>
<td class="prev shortcut"><kbd>p</kbd></td>
<td>Previous page</td>
</tr>
<tr>
<td class="search shortcut"><kbd>s</kbd></td>
<td>Search</td>
</tr>
</tbody>
</table>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div>
</body>
</html>
